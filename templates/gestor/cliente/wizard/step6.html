{% extends 'gestor/base_gestor.html' %}

{% block title %}Cliente - Revis√£o Final | Portal Marketing{% endblock %}

{% block content %}
<div class="card shadow">
  <div class="card-header bg-light">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0">
        <i class="fas fa-check-circle me-2"></i>
        Revis√£o Final - {{ cliente.nome_empresa }}
      </h5>
      <div>
        <a href="{% url 'gestor:cliente_list' %}" class="btn btn-outline-secondary btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Voltar
        </a>
      </div>
    </div>
    
    <div class="progress mb-3" style="height: 8px;">
      <div class="progress-bar bg-success" role="progressbar" style="width: 100%" aria-valuenow="6" aria-valuemin="0" aria-valuemax="6"></div>
    </div>
    
    <div class="d-flex justify-content-between text-center">
      <div class="flex-fill">
        <div class="badge bg-success rounded-pill mb-1">‚úì</div>
        <div class="small text-success">B√°sicas</div>
      </div>
      <div class="flex-fill">
        <div class="badge bg-success rounded-pill mb-1">‚úì</div>
        <div class="small text-success">P√∫blico</div>
      </div>
      <div class="flex-fill">
        <div class="badge bg-success rounded-pill mb-1">‚úì</div>
        <div class="small text-success">Posicionamento</div>
      </div>
      <div class="flex-fill">
        <div class="badge bg-success rounded-pill mb-1">‚úì</div>
        <div class="small text-success">Objetivos</div>
      </div>
      <div class="flex-fill">
        <div class="badge bg-success rounded-pill mb-1">‚úì</div>
        <div class="small text-success">Recursos</div>
      </div>
      <div class="flex-fill">
        <div class="badge bg-success rounded-pill mb-1">6</div>
        <div class="small fw-bold text-success">Revis√£o</div>
      </div>
    </div>
  </div>
  
  <div class="card-body">
    <form method="post" novalidate id="step6Form">
      {% csrf_token %}
      {{ wizard.management_form }}
      
      <div class="alert alert-success">
        <h5><i class="fas fa-trophy me-2"></i>Parab√©ns! Briefing Completo</h5>
        <p class="mb-0">Voc√™ completou todas as etapas do briefing. Revise as informa√ß√µes abaixo antes de finalizar o cadastro do cliente.</p>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">
            <i class="fas fa-building me-2"></i>
            Informa√ß√µes B√°sicas
          </h6>
          {# REMOVIDO: Link para step1 individual #}
          <span class="badge bg-info">Step 1 Completo</span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">Nome da Empresa:</dt>
                <dd class="col-sm-7">{{ cliente.nome_empresa }}</dd>
                
                <dt class="col-sm-5">Respons√°vel:</dt>
                <dd class="col-sm-7">{{ cliente.responsavel_contrato|default:"-" }}</dd>
                
                <dt class="col-sm-5">Cargo:</dt>
                <dd class="col-sm-7">{{ cliente.cargo_responsavel|default:"-" }}</dd>
                
                <dt class="col-sm-5">Contato:</dt>
                <dd class="col-sm-7">{{ cliente.contato_responsavel|default:"-" }}</dd>
              </dl>
            </div>
            <div class="col-md-6">
              <dl class="row">
                <dt class="col-sm-5">CNPJ/CPF:</dt>
                <dd class="col-sm-7">{{ cliente.cnpj_cpf|default:"-" }}</dd>
                
                <dt class="col-sm-5">Website:</dt>
                <dd class="col-sm-7">
                  {% if cliente.website_principal %}
                    <a href="{{ cliente.website_principal }}" target="_blank">{{ cliente.website_principal }}</a>
                  {% else %}
                    -
                  {% endif %}
                </dd>
                
                <dt class="col-sm-5">Status:</dt>
                <dd class="col-sm-7">
                  {% if cliente.ativo %}
                    <span class="badge bg-success">Ativo</span>
                  {% else %}
                    <span class="badge bg-warning">Inativo</span>
                  {% endif %}
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">
            <i class="fas fa-users me-2"></i>
            P√∫blico-Alvo
          </h6>
          {# REMOVIDO: Link para step2 individual #}
          <span class="badge bg-info">Step 2 Completo</span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>Descri√ß√£o do P√∫blico:</strong>
              <p class="text-muted">{{ cliente.descricao_publico|truncatewords:20|default:"N√£o informado" }}</p>
              
              <strong>Necessidades e Desejos:</strong>
              <p class="text-muted">{{ cliente.necessidades_desejos|truncatewords:20|default:"N√£o informado" }}</p>
            </div>
            <div class="col-md-6">
              <strong>Comportamento de Compra:</strong>
              <p class="text-muted">{{ cliente.comportamento_compra|truncatewords:20|default:"N√£o informado" }}</p>
              
              {% if cliente.objecoes_comuns %}
              <strong>Obje√ß√µes Comuns:</strong>
              <p class="text-muted">{{ cliente.objecoes_comuns|truncatewords:15 }}</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">
            <i class="fas fa-bullseye me-2"></i>
            Posicionamento e Comunica√ß√£o
          </h6>
          {# REMOVIDO: Link para step3 individual #}
          <span class="badge bg-info">Step 3 Completo</span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>Posicionamento Atual:</strong>
              <p class="text-muted">{{ cliente.posicionamento_atual|truncatewords:15|default:"N√£o informado" }}</p>
              
              <strong>Tom e Voz:</strong>
              <p class="text-muted">{{ cliente.tom_voz|truncatewords:10|default:"N√£o informado" }}</p>
            </div>
            <div class="col-md-6">
              <strong>Mensagem Principal:</strong>
              <p class="text-muted">{{ cliente.mensagem_principal|truncatewords:15|default:"N√£o informado" }}</p>
              
              {% if cliente.arquetipos %}
              <strong>Arqu√©tipos Selecionados:</strong>
              <div>
                {% for arquetipo in cliente.arquetipos %}
                  <span class="badge bg-primary me-1">{{ arquetipo|title }}</span>
                {% endfor %}
              </div>
              {% else %}
              <strong>Arqu√©tipos:</strong>
              <p class="text-muted">N√£o selecionados</p>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">
            <i class="fas fa-target me-2"></i>
            Objetivos e Estrat√©gia
          </h6>
          {# REMOVIDO: Link para step4 individual #}
          <span class="badge bg-info">Step 4 Completo</span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>Objetivos de Marketing:</strong>
              <p class="text-muted">{{ cliente.objetivos_marketing|truncatewords:20|default:"N√£o informado" }}</p>
              
              <strong>Metas Espec√≠ficas:</strong>
              <p class="text-muted">{{ cliente.metas_especificas|truncatewords:20|default:"N√£o informado" }}</p>
            </div>
            <div class="col-md-6">
              <strong>KPIs:</strong>
              <p class="text-muted">{{ cliente.kpis_empresa|truncatewords:15|default:"N√£o informado" }}</p>
              
              <strong>Principais Concorrentes:</strong>
              <p class="text-muted">{{ cliente.analise_concorrencia|truncatewords:15|default:"N√£o informado" }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
          <h6 class="card-title mb-0">
            <i class="fas fa-cogs me-2"></i>
            Recursos e Expectativas
          </h6>
          {# REMOVIDO: Link para step5 individual #}
          <span class="badge bg-info">Step 5 Completo</span>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>Or√ßamento de Marketing:</strong>
              <p class="text-muted">
                {% if cliente.orcamento_marketing %}
                  R$ {{ cliente.orcamento_marketing|floatformat:2 }}
                {% else %}
                  N√£o informado
                {% endif %}
              </p>
              
              <strong>Equipe de Marketing:</strong>
              <p class="text-muted">{{ cliente.equipe_marketing|truncatewords:15|default:"N√£o informado" }}</p>
            </div>
            <div class="col-md-6">
              <strong>Ferramentas Digitais:</strong>
              <div class="mb-2">
                {% if cliente.google_analytics %}
                  <span class="badge bg-success">Google Analytics</span>
                {% endif %}
                {% if cliente.tag_manager %}
                  <span class="badge bg-success">Tag Manager</span>
                {% endif %}
                {% if cliente.pixel_facebook %}
                  <span class="badge bg-success">Pixel Facebook</span>
                {% endif %}
                {% if not cliente.google_analytics and not cliente.tag_manager and not cliente.pixel_facebook %}
                  <span class="text-muted">Nenhuma ferramenta configurada</span>
                {% endif %}
              </div>
              
              <strong>CRM:</strong>
              <p class="text-muted">{{ cliente.crm_utilizado|default:"N√£o informado" }}</p>
            </div>
          </div>
        </div>
      </div>

      <div class="alert alert-info">
        <h6><i class="fas fa-list-ul me-2"></i>Pr√≥ximos Passos:</h6>
        <ol class="mb-0">
          <li><strong>Finalizar Cadastro:</strong> Clique em "Finalizar Cadastro" para salvar todas as informa√ß√µes</li>
          <li><strong>Criar Produtos/Servi√ßos:</strong> Adicione produtos espec√≠ficos que ser√£o promovidos</li>
          <li><strong>Configurar Campanhas:</strong> Configure as primeiras campanhas de marketing</li>
          <li><strong>Acompanhar Resultados:</strong> Use o dashboard para monitorar performance</li>
        </ol>
      </div>

      <div class="d-flex justify-content-between mt-4">
        <div>
          <button type="submit" class="btn btn-outline-secondary" name="wizard_goto_step" value="step5">
            <i class="fas fa-arrow-left me-1"></i> Anterior: Recursos
          </button>
        </div>
        <div>
          <button type="button" class="btn btn-outline-warning me-2" id="saveDraft">
            <i class="fas fa-save me-1"></i> Salvar como Rascunho
          </button>
          <button type="submit" class="btn btn-success btn-lg" name="action" value="finish" id="finishBtn">
            <i class="fas fa-check-circle me-1"></i> Finalizar Cadastro
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">
          <i class="fas fa-check-circle me-2"></i>Finalizar Cadastro
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Voc√™ est√° prestes a finalizar o cadastro do cliente <strong>{{ cliente.nome_empresa }}</strong>.</p>
        <p>Ap√≥s finalizar, voc√™ poder√°:</p>
        <ul>
          <li>Adicionar produtos/servi√ßos espec√≠ficos</li>
          <li>Criar campanhas de marketing</li>
          <li>Acompanhar resultados no dashboard</li>
          <li>Editar informa√ß√µes a qualquer momento</li>
        </ul>
        <p class="mb-0"><strong>Confirma a finaliza√ß√£o do cadastro?</strong></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="confirmFinish">
          <i class="fas fa-check-circle me-1"></i> Sim, Finalizar
        </button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  
  const form = document.getElementById('step6Form');
  const finishBtn = document.getElementById('finishBtn');
  const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
  
  // Modificar o listener do submit do formul√°rio principal
  form.addEventListener('submit', function(e) {
    const submitter = e.submitter; // O bot√£o que disparou o submit
    
    // Se o bot√£o clicado foi o de "Finalizar Cadastro" ou "Salvar Rascunho",
    // a l√≥gica de fetch j√° est√° no JavaScript deles.
    // Para todos os outros bot√µes (como 'Anterior'), permita o submit normal.
    if (submitter && (submitter.id === 'finishBtn' || submitter.id === 'saveDraft')) {
      e.preventDefault(); // Previne o submit default, pois o fetch ser√° feito manualmente
    }
    // Se o submit n√£o foi pelos bot√µes com ID 'finishBtn' ou 'saveDraft',
    // permite que o formul√°rio seja submetido normalmente (o que √© necess√°rio para 'previous').
  });

  // ===== FINALIZAR CADASTRO =====
  finishBtn.addEventListener('click', function(e) {
    // A preven√ß√£o padr√£o j√° est√° no listener do formul√°rio acima, mas refor√ßar aqui n√£o faz mal
    // e.preventDefault(); // Comentado, pois j√° √© tratado pelo listener do form
    confirmModal.show();
  });
  
  document.getElementById('confirmFinish').addEventListener('click', function() {
    confirmModal.hide();
    
    // Submeter formul√°rio para finalizar
    const formData = new FormData(form);
    formData.set('action', 'finish'); // Certifica que a a√ß√£o 'finish' √© enviada
    
    finishBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Finalizando...';
    finishBtn.disabled = true;
    
    const currentPath = window.location.pathname;
    
    fetch(currentPath, { 
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('Cliente cadastrado com sucesso!', 'success');
        
        setTimeout(() => {
          window.location.href = data.redirect_url || "{% url 'gestor:cliente_detail' cliente.pk %}";
        }, 2000);
        
      } else {
        showToast('Erro ao finalizar cadastro: ' + (data.message || 'Erro desconhecido'), 'danger');
        finishBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> Finalizar Cadastro';
        finishBtn.disabled = false;
      }
    })
    .catch(error => {
      console.error('Erro:', error);
      showToast('Erro ao finalizar cadastro', 'danger');
      finishBtn.innerHTML = '<i class="fas fa-check-circle me-1"></i> Finalizar Cadastro';
      finishBtn.disabled = false;
    });
  });
  
  // ===== SALVAR RASCUNHO =====
  const saveDraftBtn = document.getElementById('saveDraft');
  if (saveDraftBtn) {
    saveDraftBtn.addEventListener('click', function() {
      // A preven√ß√£o padr√£o j√° est√° no listener do formul√°rio acima
      
      const formData = new FormData(form);
      formData.set('action', 'save_draft'); // Certifica que a a√ß√£o 'save_draft' √© enviada
      
      const originalText = this.innerHTML;
      this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Salvando...';
      this.disabled = true;
      
      const currentPath = window.location.pathname; 
      
      fetch(currentPath, { 
        method: 'POST',
        body: formData,
        headers: {
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showToast('Rascunho salvo com sucesso!', 'success');
        } else {
          showToast('Erro ao salvar rascunho', 'danger');
        }
      })
      .catch(error => {
        console.error('Erro:', error);
        showToast('Erro ao salvar rascunho', 'danger');
      })
      .finally(() => {
        this.innerHTML = originalText;
        this.disabled = false;
      });
    });
  }
  
  // ===== FUN√á√ÉO TOAST =====
  function showToast(message, type = 'info') {
    const toastHtml = `
      <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
      </div>
    `;
    
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
      toastContainer = document.createElement('div');
      toastContainer.id = 'toast-container';
      toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
      toastContainer.style.zIndex = '1056';
      document.body.appendChild(toastContainer);
    }
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, { delay: type === 'success' ? 4000 : 3000 });
    toast.show();
    
    toastElement.addEventListener('hidden.bs.toast', () => {
      toastElement.remove();
    });
  }
  
  // ===== EFEITO VISUAL DE CONCLUS√ÉO =====
  setTimeout(() => {
    const cards = document.querySelectorAll('.card.shadow-sm');
    cards.forEach((card, index) => {
      setTimeout(() => {
        card.style.opacity = '0.3';
        card.style.transform = 'scale(0.98)';
        card.style.transition = 'all 0.3s ease';
        
        setTimeout(() => {
          card.style.opacity = '1';
          card.style.transform = 'scale(1)';
        }, 100);
      }, index * 200);
    });
  }, 500);
  
  console.log('üéâ Cliente Form Step 6 (Final) carregado com sucesso!');
});
</script>
{% endblock %}